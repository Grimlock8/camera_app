@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@{
    ViewData["Title"] = "Camera Page";
}

<p> <canvas id="canvas"></canvas> </p>
<button id="start-button" onclick="startFunction()">Grab one frame</button>
<button onclick="invert()">Invert grabbed frame</button>

<script>

//const constraints = { "video": { width: { max: 320 } } };
    var constraints = { 
    video: { 
        facingMode: {exact: "user" },        
            width: { ideal: 1920 },
            height: { ideal: 1080 }
    }, 
    audio: false 
};
var canvas = document.getElementById('canvas');
var videoTrack;

function startFunction() {
  navigator.mediaDevices.getUserMedia(constraints)
      .then(gotMedia)
      .catch(e => { console.error('getUserMedia() failed: ', e); });
}

function gotMedia(mediastream) {
  videoTrack = mediastream.getVideoTracks()[0];
  var imageCapture = new ImageCapture(videoTrack);
  imageCapture.grabFrame()
      .then(processFrame)
      .catch(e => console.error('grabFrame() failed: ' + e));
}

function processFrame(imageBitmap) {
  canvas.width = imageBitmap.width;
  canvas.height = imageBitmap.height;
  canvas.getContext('2d').drawImage(imageBitmap, 0, 0);

  videoTrack.stop();
}

function invert() {
  var ctx = canvas.getContext('2d');
  var imageData = ctx.getImageData(0,0,canvas.width, canvas.height);

  var data = imageData.data;
  for (var i = 0; i < data.length; i += 4) {
    data[i]     = 255 - data[i];     // red
    data[i + 1] = 255 - data[i + 1]; // green
    data[i + 2] = 255 - data[i + 2]; // blue
  }
  ctx.putImageData(imageData, 0, 0);
}
</script>
